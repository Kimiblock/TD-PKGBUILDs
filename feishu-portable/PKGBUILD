pkgname=feishu-portable
pkgver=7.42.17
pkgrel=1
epoch=1
pkgdesc="Linux client of Feishu (Lark) from Bytedance. Sandboxed by portable."
arch=('any')
url="https://github.com/Kraftland/portable"
license=('GPL3')
options=(!debug !strip '!emptydirs')
provides+=('feishu-bin' 'feishu')
conflicts=('feishu' 'feishu-bin')
source_x86_64=("https://sf3-cn.feishucdn.com/obj/ee-appcenter/${_pkghash_x64}/Feishu-linux_x64-${pkgver}.deb")
source_aarch64=("https://sf3-cn.feishucdn.com/obj/ee-appcenter/${_pkghash_arm64}/Feishu-linux_arm64-${pkgver}.deb")
sha256sums_x86_64=('46cabec500328bb23559c9e45f384f1206d4c9f5d4f573d5288bafe99f47e550')
sha256sums_aarch64=('53291093c47c103b079911b2f417c35e1119165613d7a6c0911b8b5c56490c7c')

source=(
    portable-config
    feishu-portable.hook
    com.bytedance.feishu.desktop
    feishu.sh
    install-hook.sh
)

sha256sums=(
    'e58d67afa4ca6fb6fbfea599a7fae72c9a989d80135eb737262676e0b7045725'
    '45c34eae67933b1c5a8fcfb6dddfa866e32f3ddc4e9fddf08aa7e83acfc698b3'
    '653848a197d08b7a76981c1b60960a55833d9828cfde63f184edd645a7a9d432'
    '2c520dee7e31aae11d7f59de514562698d97388eb58708db33666d3bb0e40b43'
    '55a4b50a1322c14c274c159a20f5fbb8369fc2351af9d698e38ec2df0fdf7e7e'
)

function package() {
	depends+=('ca-certificates' 'gtk3' 'nss' 'xdg-utils' 'dnsmasq' 'portable')
	tar xpvf "${srcdir}/data.tar.xz" --xattrs-include='*' --numeric-owner -C "${pkgdir}"
	rm -rf \
		"${pkgdir}/usr/share/applications"
	rm -rf \
		"${pkgdir}/usr/share/menu"
	rm -rf \
		"${pkgdir}/usr/bin"
	install -Dm755 \
		portable-config \
		"${pkgdir}/usr/lib/portable/info/com.bytedance.feishu/config"
	install -Dm644 \
		com.bytedance.feishu.desktop \
		"${pkgdir}/usr/share/applications/com.bytedance.feishu.desktop"
	install -Dm755 \
		feishu.sh \
		"${pkgdir}/usr/lib/feishu-portable"
	install -Dm755 \
		feishu.sh \
		"${pkgdir}/usr/lib/feishu"
	# This is from the original feishu PKGBUILD, I have no idea why it's there
	sed -i \
		's/bytedance-feishu/feishu/g' \
		"${pkgdir}/usr/share/appdata/bytedance-feishu.appdata.xml"
	sed -i \
		's/bytedance-feishu/feishu/g' \
		"${pkgdir}/opt/bytedance/feishu/bytedance-feishu"
}
